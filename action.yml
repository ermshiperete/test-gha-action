name: Ubuntu packaging
description: Build binary .deb package

branding:
  color: orange
  icon: package

inputs:
  flavor:
    description: 'The name of the distribution, i.e. Ubuntu or Debian. Defaults to `ubuntu`.'
    required: false
    default: 'ubuntu'
  dist:
   description: 'The name of a Ubuntu/Debian version, either code name (e.g. jammy) or release (e.g. 22.04)'
   required: true
  platform:
    description: 'The platform to build on. One of `amd64` or `i386`. Defaults to `amd64`.'
    required: false
    default: 'amd64'
  sourcepackage:
    description: 'The name (and relative path) of the .dsc file'
    required: true
  source_dir:
    description: 'The path to the directory that contains the .dsc file (relative to $GITHUB_WORKSPACE).'
    required: false
    default: '.'
  result_dir:
    description: 'The path to the directory where the built .deb files get copied to (relative to $GITHUB_WORKSPACE).'
    required: false
    default: 'artifacts'
  enable_llso:
    description: 'true to enable the llso package repo, otherwise false.'
    required: false
    default: 'true'
  enable_pso:
    description: 'true to enable the pso package repo, otherwise false.'
    required: false
    default: 'true'
  deb_fullname:
    description: 'Full name used for changelog entry'
    required: false
    default: 'SIL GHA Packager'
  deb_email:
    description: 'Email address used for changelog entry'
    required: false
    default: 'undelivered@sil.org'
  prerelease_tag:
    description: 'A pre-release tag to add to the version number'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Verify input
      shell: bash
      run: |
        if [ "${{inputs.flavor}}" == "ubuntu" ] && [ "${{inputs.platform}}" == "i386" ]; then
          echo "::error::Platform i386 is not supported for Ubuntu"
          exit 1
        fi

    - name: Build Docker image
      shell: bash
      run: |
        IMAGE_ID=$(docker images --quiet "${IMAGE_NAME}")
        if [ -z "$IMAGE_ID" ]; then
          echo "::notice::Building docker image for ${INPUT_DIST}"
          docker build --build-arg DIST="${INPUT_DIST}" --build-arg PLATFORM=${INPUT_PLATFORM} --build-arg DISTRIBUTION=${INPUT_DISTRIBUTION} --build-arg ENABLE_LLSO=${INPUT_ENABLE_LLSO} --build-arg ENABLE_PSO=${INPUT_ENABLE_PSO} -t "${IMAGE_NAME}" .
        fi
      working-directory: ${{github.action_path}}
      env:
        INPUT_DISTRIBUTION: "${{inputs.flavor}}"
        INPUT_DIST: "${{inputs.dist}}"
        INPUT_PLATFORM: "${{inputs.platform}}"
        INPUT_ENABLE_LLSO: "${{inputs.enable_llso}}"
        INPUT_ENABLE_PSO: "${{inputs.enable_pso}}"
        IMAGE_NAME: "${{github.actor}}/sil-${{inputs.flavor}}-${{inputs.dist}}-${{inputs.platform}}-${{inputs.enable_pso}}-${{inputs.enable_llso}}"


    - name: Build package
      shell: bash
      run: docker run -v "/var/run/docker.sock":"/var/run/docker.sock" -v "${{inputs.source_dir}}":/source --env INPUT_DISTRIBUTION --env INPUT_DIST --env INPUT_PLATFORM --env INPUT_SOURCEPACKAGE --env INPUT_SOURCE_DIR --env INPUT_RESULT_DIR --env INPUT_ENABLE_LLSO --env INPUT_ENABLE_PSO --env INPUT_DEB_FULLNAME --env INPUT_DEB_EMAIL --env INPUT_PRERELEASE_TAG --workdir /source --platform="linux/${{inputs.platform}}" "${{github.actor}}/sil-${{inputs.flavor}}-${{inputs.dist}}-${{inputs.platform}}-${{inputs.enable_pso}}-${{inputs.enable_llso}}" "${{inputs.dist}}" "${{inputs.sourcepackage}}" .
      working-directory: ${{inputs.source_dir}}
      env:
        INPUT_DISTRIBUTION: "${{inputs.flavor}}"
        INPUT_DIST: "${{inputs.dist}}"
        INPUT_PLATFORM: "${{inputs.platform}}"
        INPUT_SOURCEPACKAGE: "${{inputs.sourcepackage}}"
        INPUT_SOURCE_DIR: "${{inputs.source_dir}}"
        INPUT_RESULT_DIR: "${{inputs.result_dir}}"
        INPUT_ENABLE_LLSO: "${{inputs.enable_llso}}"
        INPUT_ENABLE_PSO: "${{inputs.enable_pso}}"
        INPUT_DEB_FULLNAME: "${{inputs.deb_fullname}}"
        INPUT_DEB_EMAIL: "${{inputs.deb_email}}"
        INPUT_PRERELEASE_TAG: "${{inputs.prerelease_tag}}"

